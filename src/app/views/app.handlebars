(function() {
    var handlebarsUrl = '//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.4/handlebars.amd.min',
        requirejsUrl = '//cdnjs.cloudflare.com/ajax/libs/require.js/2.1.14/require.min.js';

    function configureCommitStreamDependencies() {
        require.config({
            paths: {
                handlebars: handlebarsUrl
            }
        });
    }

    var deps = ['handlebars'];
    function hasAllDeps() {
        if (!window.requirejs) return false;
        for(var i = 0; i < deps.length; i++) {
            if (!requirejs.defined(deps[i])) return false;
        }
        return true;
    }

    var assetDetailCommitsTmpl = null;
    function render(commitStreamDomId, data, errorHandler) {
        try {
            var content = assetDetailCommitsTmpl(data);
            $(commitStreamDomId).html(content);
        } catch(ex) {
            errorHandler();
        }
    }

    function queryCommitStream(commitStreamDomId, workitem, handlebars, errorHandler) {
        $.getJSON('{{{apiUrl}}}' + workitem).done(function(data) {
            if (!data || !data.commits) {
                errorHandler();
            } else {
                data.noCommits = data.commits.length < 1;
                data.resourcePath = "{{{resourcePath}}}";

                if (assetDetailCommitsTmpl === null) {
                    $.get('{{{templateUrl}}}').done(function(source) {
                        try {
                            assetDetailCommitsTmpl = handlebars.compile(source);
                            render(commitStreamDomId, data, errorHandler);
                        } catch(ex) {
                            errorHandler();
                        }
                    }).fail(errorHandler);
                } else {
                    render(commitStreamDomId, data, errorHandler);
                }
            }
        }).fail(errorHandler);
    }

    function invokeCommitStream(commitStreamDomId, workitem, errorHandler) {
        require(deps, function(handlebars) {
            queryCommitStream(commitStreamDomId, workitem, handlebars.default, errorHandler);
        }, errorHandler);
    }

    // Put a commitStream object in the global space
    if (!window.CommitStream) {
        window.CommitStream = {
            commitsDisplay : function(commitStreamDomId, workitem, errorHandler) {
                try {
                    if (!hasAllDeps()) {
                        $.getScript(requirejsUrl, function(data, status, jqxhr) {
                            configureCommitStreamDependencies();
                            invokeCommitStream(commitStreamDomId, workitem, errorHandler);
                        }).fail(errorHandler);
                    } else {
                        invokeCommitStream(commitStreamDomId, workitem, errorHandler);
                    }
                } catch (ex) {
                    console.log(ex);
                }
            }
        };
    }
})();
